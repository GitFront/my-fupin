$.namespace("common.report.highcharts"),Array.prototype.contains=function(a){for(var t=this.length;t--;)if(this[t]===a)return!0;return!1},Highcharts.setOptions({lang:{drillUpText:"返回 > {series.name}"}});var Highmap={mapid:"",levelid:"",levelname:"",levarray:new Array,namearray:new Array,mapValue:{},pointFormat:{},mapObject:{},setLoading:[],showPoint:!1,valueType:"map",topMapNode:common.utils.guid(),ChartDataFormate:{FormatGroupData:function(a){common.utils.isArray(a)||(a=[]);for(var t=new Array,o=new Array,e=new Array,i=0;i<a.length;i++)t.contains(a[i].name)||t.push(a[i].name),o.contains(a[i].group)||o.push(a[i].group);for(i=0;i<o.length;i++){var n={},r=o[i],p=!0;o[i].endsWith("|hide")&&(p=!1,r=o[i].replace("|hide",""));for(var m=new Array,l=0;l<a.length;l++)for(var s=0;s<t.length;s++)o[i]==a[l].group&&a[l].name==t[s]&&m.push(a[l].value);n={name:r,data:m,visible:p},e.push(n)}return{category:t,series:e}},FormatMapData:function(a,t){var o={},e=new Array,i=Highmap.valueType;return $.each(a,function(a){var n=this;if("mapbubble"!==i||n.hasOwnProperty("z")||(n.z=n.value),n.hasOwnProperty(t)&&"-1"===n[t]||!n.hasOwnProperty(t))e.push(n);else{var r=n[t];o.hasOwnProperty(r)?o[r].push(n):(o[r]=new Array,o[r].push(n))}}),o[Highmap.topMapNode]=e,o}},MapOptionTemplates:{Map:function(container,data,mapData,joinBy,opt){Highmap.mapValue=data,Highmap.valueType=opt.valueType,Highmap.showPoint=opt.showPoint,Highmap.setLoading=opt.setLoading;var mapValue_=Highmap.ChartDataFormate.FormatMapData(data,opt.parentKey);Highmap.pointFormat=Highmap.utils.convValueFormat(opt.valueMapper,opt.valueSuffix);var series=Highmap.utils.createMapSeries(opt.mapName,mapValue_[Highmap.topMapNode],mapData,joinBy),option={chart:{height:opt.height,backgroundColor:"#151618",renderTo:container,events:{drilldown:function(a){window.alert("drilldown")},drillup:function(e){common.utils.isDefined(this.subtitle)&&this.setTitle(null,{text:e.seriesOptions.name}),Highmap.showPoint&&Highmap.mapObject.series[0].remove(!1),Highmap.levarray.pop(),Highmap.namearray.pop(),Highmap.levelid=Highmap.levarray[Highmap.levarray.length-1],Highmap.levelname=e.seriesOptions.name;var funcName=opt.doDrillup;common.utils.isFunction(funcName)&&eval(funcName+"(e.point,Highmap.levelid)")}}},title:{text:""},credits:{enabled:!1},subtitle:{text:"",floating:!0,align:"right",y:50,style:{fontSize:"16px"}},legend:opt.legend,colorAxis:{min:0,stops:opt.colorStops},loading:{labelStyle:{fontWeight:"bold",position:"relative",top:"45%"},showDuration:10,style:{position:"absolute",backgroundColor:"#c1c1c1",opacity:.2,textAlign:"center"}},exporting:{enabled:!1},colors:{radialGradient:{cx:.5,cy:.3,r:.7},stops:[[0,void 0],[1,Highcharts.Color(void 0).brighten(-.3).get("rgb")]]},mapNavigation:{enabled:opt.navigation,enableButtons:opt.navigationButton},plotOptions:{series:{cursor:opt.cursor,events:{click:function(e){if(!e.seriesOptions){if(opt.isDrilldown){var cname=e.point.properties.name,key=e.point.properties[joinBy],dmv_=Highmap.ChartDataFormate.FormatMapData(Highmap.mapValue,opt.parentKey),drillKey=e.point.properties[opt.drillKey];common.utils.isDefined(drillKey)&&(Highmap.utils.mapDrilldown(e.point,drillKey,joinBy,dmv_[key]),Highmap.levarray.push(key),Highmap.namearray.push(cname),Highmap.levelid=key,Highmap.levelname=cname)}opt.title&&Highmap.mapObject.setTitle(null,{text:cname});var funcName=opt.doClick;common.utils.isFunction(funcName)&&eval(funcName+"(e.point,Highmap.levelid)")}}}}},series:series,drilldown:{activeDataLabelStyle:{color:"#FFFFFF",textDecoration:"none",textShadow:"0 0 3px #000000"},animation:!0,drillUpButton:{relativeTo:"spacingBox",position:{y:0,x:0},theme:{fill:"white","stroke-width":1,stroke:"silver",r:0,states:{hover:{fill:"#bada55"},select:{stroke:"#039",fill:"#bada55"}}}}}};return option}},create:{init:function(container,data,mapData,joinBy,option){var type="Map",option_=Highmap.utils.defaultOption(option);option_.container=container,option_.optionType=type;var opt=eval("Highmap.MapOptionTemplates."+type+"(container,data,mapData,joinBy,option_)");Highmap.mapObject=new Highcharts.Map(opt),Highmap.levarray.push(Highmap.topMapNode),Highmap.namearray.push(option_.mapName),Highmap.levelid=Highmap.topMapNode,Highmap.levelname=option_.mapName,Highmap.showPoint&&Highmap.utils.loadMappoint(),option_.title&&Highmap.mapObject.setTitle(null,{text:option_.mapName});var obj={chart:Highmap.mapObject,chartType:type,option:option_,data:data,mapData:mapData,joinBy:joinBy};return Highmap.mapid=common.report.highcharts.object.add(obj),Highmap.mapid}},loadData:function(a,t,o,e){var i=common.report.highcharts.object.get(a);if(null!=i){var n=i.chart;Highmap.utils.mapShowLoading();var r=i.option;common.utils.isDefined(t)||(t=i.data),common.utils.isDefined(o)||(o=i.valueMapper),Highmap.mapValue=t;var p=Highmap.ChartDataFormate.FormatMapData(t,r.parentKey);Highmap.pointFormat=Highmap.utils.convValueFormat(o,r.valueSuffix),e?(n.series[0].setData(p[Highmap.levelid]),n.series[1].setData(p[Highmap.levarray[Highmap.levarray.length-2]])):n.series[0].setData(p[Highmap.levelid]),i.chart=n,i.data=t,common.report.highcharts.object.reset(a,i),n.redraw(!0),Highmap.utils.mapHideLoading()}},reload:function(chartid,data,newOption){var obj=common.report.highcharts.object.get(chartid);if(null!=obj){var chart=obj.chart;Highmap.utils.mapShowLoading();var opt=obj.option,mapData=obj.mapData,joinBy=obj.joinBy,container=opt.container,type=opt.optionType;common.utils.isDefined(data)||(data=obj.data),common.utils.isDefined(newOption)&&(opt=Highmap.utils.defaultOption(newOption),opt.container=container,opt.optionType=type);var option=eval("Highmap.MapOptionTemplates."+type+"(container,data,mapData,joinBy,opt)");return Highmap.utils.mapHideLoading(),chart.destroy(),chart=new Highcharts.Map(option),obj.chart=chart,obj.option=opt,obj.data=data,common.report.highcharts.object.reset(chartid,obj),!0}return!1},remove:function(a){return!!common.report.highcharts.object.containsKey(a)&&(common.report.highcharts.object.get(a).chart.destroy(),common.report.highcharts.object.remove(a),!0)},ajax:{init:function(a,t,o,e,i,n){var r=Highmap.create.init(a,[],e,i,n),p=common.report.highcharts.object.get(r);p.chart;return Highmap.utils.mapShowLoading(),o=common.utils.strToJson(o),$.ajax({type:"POST",url:t,data:o,cache:!0,dataType:"json",success:function(a){Highmap.reload(r,a),Highmap.utils.mapHideLoading(),(p=common.report.highcharts.object.get(r)).url=t,p.parameters=o,common.report.highcharts.object.reset(r,p)}}),r},reload:function(a,t,o,e){var i=common.report.highcharts.object.get(a);if(null==i)return!1;if(common.utils.isEmpty(t)){var n=i.data;return Highmap.reload(a,n,e)}i.chart;Highmap.utils.mapShowLoading(),common.utils.isEmpty(t)&&(t=i.url),common.utils.isEmpty(o)&&(o=i.parameters),o=common.utils.strToJson(o),$.ajax({type:"POST",url:t,data:o,cache:!0,dataType:"json",success:function(n){return Highmap.reload(a,n,e),Highmap.utils.mapHideLoading(),i=common.report.highcharts.object.get(a),i.url=t,i.parameters=o,common.report.highcharts.object.reset(a,i),!0}})}},mybatis:{Map:function(a,t,o,e,i,n,r){var p=ctx+"/a/report/highmaps/mapData/load",m={};return m.queryName=t,m.param=common.utils.strToJson(o),m.mapper=common.utils.strToJson(e),m.joinBy=n,Highmap.ajax.init(a,p,m,i,n,r)},reload:function(a,t,o,e,i){var n=common.report.highcharts.object.get(a);if(null!=n){var r=n.url,p=n.parameters;return common.utils.isEmpty(t)||(p.queryName=t),common.utils.isEmpty(o)||(p.param=common.utils.strToJson(o)),common.utils.isEmpty(e)||(p.mapper=common.utils.strToJson(e)),Highmap.ajax.reload(a,r,p,i)}return!1}},utils:{defaultOption:function(a){var t={title:!0,mapName:"",height:500,width:800,showPoint:!1,colorStops:["#EFEFFF",Highcharts.getOptions().colors[0],"#006cee"],valueType:"map",valueDecimal:0,percentDecimal:2,valueSuffix:"",setLoading:[],legend:!0,legendFloat:!1,legendAlign:"right",navigation:!0,navigationButton:!0,valueMapper:[{key:"value",name:"数值"}],isDrilldown:!1,parentKey:"parentKey",drillKey:"drill-key",doClick:"",doDrillup:""},o=common.utils.setDefaultOption(a,t);return o.legend=this.convLegend(o),o.colorStops=this.convColorstops(o.colorStops),o.navigation||(o.navigationButton=!1),o.cursor="",common.utils.isFunction(o.doClick)&&(o.cursor="pointer"),o},convLegend:function(a){var t={};if(!a.legend)return t.enabled=!1,t;switch(t.enabled=!0,t.floating=a.legendFloat,a.legendAlign){case"left":t.align="left",t.layout="vertical",t.verticalAlign="middle";break;case"top":t.layout="horizontal",t.verticalAlign="top";break;case"bottom":t.layout="horizontal",t.verticalAlign="bottom";break;default:t.align="right",t.layout="vertical",t.verticalAlign="middle"}return t},convColorstops:function(a){var t=[[0,"#EFEFFF"],[.5,Highcharts.getOptions().colors[0]],[1,"#006cee"]];if(!common.utils.isArray(a))return t;var o=new Array,e=a.length;switch(e){case 0:case 1:o=t;break;default:for(var i=1/(e-1),n=0;n<e;n++)o.push([i*n,a[n]])}return o},convValueFormat:function(a,t){var o='<p><b style="font-weight:bold;color:#F58221;font-size:13px">{point.properties.name}<b/><br>';if(common.utils.isArray(a)){for(var e=0;e<a.length;e++)o+=0===e?'<b style="color:#f4e925;font-size:12px">'+a[e].name+'：</b><b style="font-weight:bold;color:#f4e925;">{point.'+a[e].key+"} "+t+"</b><br/>":a[e].name+"：<b>{point."+a[e].key+"} "+t+"</b><br/>";o+="</p>"}else common.utils.isJson(a)&&(o+='<b style="color:#f4e925;font-size:12px">'+a.name+'：</b><b style="font-weight:bold;color:#f4e925;">{point.'+a.key+"} "+t+"</b><br/></p>");return o},mapDrilldown:function(a,t,o,e){if(!a.seriesOptions){a.properties[o];var i=a.properties.name;Highmap.utils.mapShowLoading(),$.ajax({type:"GET",url:"../../../static/js/modules/script/maps/json_map/"+t+".geo.json",contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0,success:function(t){if(Highmap.utils.mapHideLoading(),"mapbubble"===Highmap.valueType?(Highmap.mapObject.addSeriesAsDrilldown(a,{type:"map",name:i,mapData:Highcharts.geojson(t),enableMouseTracking:!1,borderColor:"#606060",nullColor:"rgba(200, 200, 200, 0.2)",showInLegend:!1,color:Highcharts.getOptions().colors[1],dataLabels:{enabled:!0,format:"{point.properties.name}"}}),Highmap.mapObject.addSeries({type:Highmap.valueType,mapData:Highcharts.geojson(t),name:"相对贫困户数",joinBy:[o,o],data:e,minSize:4,maxSize:"20%",states:{hover:{color:"#BADA55"}},dataLabels:{enabled:!0,format:"{point.properties.z}"},tooltip:{headerFormat:"",pointFormat:Highmap.pointFormat}})):Highmap.mapObject.addSeriesAsDrilldown(a,{type:"map",data:e,mapData:Highcharts.geojson(t),joinBy:o,name:i,borderColor:"#202125",nullColor:"#333c49",showInLegend:!1,color:Highcharts.getOptions().colors[1],states:{hover:{color:"#ffa132"},select:{color:"#ffa132"}},dataLabels:{enabled:!0,format:"{point.properties.name}"},tooltip:{headerFormat:"",pointFormat:Highmap.pointFormat}}),Highmap.showPoint){var n="相对贫困村",r=!1;Highmap.levarray.length>3&&(n="相对贫困户",Highmap.levarray.length>4&&(r=!0)),Highmap.mapObject.addSeries({name:n,type:"mappoint",data:Highcharts.geojson(t,"mappoint"),showInLegend:!0,color:"#fffc1b",marker:{radius:2},dataLabels:{align:"left",verticalAlign:"middle"},animation:!0,visible:r,tooltip:{pointFormat:"{point.name}"}}),Highmap.mapObject.redraw()}},error:function(a,t,o){common.utils.showErrorMsg("缺少地图数据，无法完成“"+i+"”的区域细化！",function(){Highmap.reload(Highmap.mapid)})}})}},loadMappoint:function(){Highmap.utils.mapShowLoading();var a=Highmap.levelid;a===Highmap.topMapNode&&(a="gd"),$.ajax({type:"GET",url:"../../../static/js/modules/script/maps/json_mappoint/"+a+"_pkcpoint.geo.json",contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0,success:function(a){Highmap.utils.mapHideLoading(),Highmap.mapObject.addSeries({name:"相对贫困村",type:"mappoint",data:Highcharts.geojson(a,"mappoint"),showInLegend:!0,color:"#fffc1b",marker:{radius:2},dataLabels:{align:"left",verticalAlign:"middle"},animation:!0,visible:!1,tooltip:{pointFormat:"{point.name}"}}),Highmap.mapObject.redraw()}})},createMapSeries:function(a,t,o,e){return"mapbubble"===Highmap.valueType?[{type:"map",name:a,mapData:Highcharts.maps[o],enableMouseTracking:!1,borderColor:"#606060",nullColor:"rgba(200, 200, 200, 0.2)",showInLegend:!1,color:Highcharts.getOptions().colors[1],dataLabels:{enabled:!0,format:"{point.properties.name}"},states:{hover:{color:"#BADA55"},select:{color:"#ffcc32"}}},{type:Highmap.valueType,mapData:Highcharts.maps[o],name:"相对贫困户数",joinBy:[e,e],data:t,minSize:4,maxSize:"20%",states:{hover:{color:"#BADA55"}},dataLabels:{enabled:!0,format:"{point.properties.z}"},tooltip:{headerFormat:"",pointFormat:Highmap.pointFormat}}]:[{type:"map",data:t,mapData:Highcharts.maps[o],joinBy:e,name:a,borderColor:"#202125",nullColor:"#333c49",showInLegend:!1,color:Highcharts.getOptions().colors[1],states:{hover:{color:"#ffa132"},select:{color:"#ffa132"}},dataLabels:{enabled:!0,format:"{point.properties.name}"},tooltip:{headerFormat:"",pointFormat:Highmap.pointFormat}}]},mapShowLoading:function(){null!==Highmap.setLoading&&Highmap.setLoading.length>1&&common.utils.isFunction(Highmap.setLoading[0])&&common.utils.isFunction(Highmap.setLoading[1])?eval(Highmap.setLoading[0]+"()"):Highmap.mapObject.showLoading('<i class="icon-spinner icon-spin icon-3x"></i>')},mapHideLoading:function(){null!==Highmap.setLoading&&Highmap.setLoading.length>1&&common.utils.isFunction(Highmap.setLoading[0])&&common.utils.isFunction(Highmap.setLoading[1])?eval(Highmap.setLoading[1]+"()"):Highmap.mapObject.hideLoading()}}};