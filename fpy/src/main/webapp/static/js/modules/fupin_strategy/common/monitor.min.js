$(function(){function e(e,a){e.html(template("tplDataMonitorTree"));var t=e.find(".tree-wrapper"),n=e.find(".tree-ul"),r=e.find(".ico-quest"),i=e.find(".tip"),o=e.data("jsp"),l=a.year,c=a.area_level,p=a.area_id,d=a.wintype,s=a.tabtype,u=a.instance;o?o.reinitialise():o=t.jScrollPane(commonJSPConfig).data("jsp"),showLoadingMask(),_({url:URLS.URL_DATA_MONITOR_TREE,data:{year:l,level:c,id:p,wintype:d,tabtype:s},success:function(e){function t(e){if(e){var t=e.area_id,n=e.area_level;u.treeCurLevel=n,u.treeCurAreaID=t,u&&u.renderContent&&u.renderContent(f({},a,{area_id:t,area_level:n,target:a.configOrder?"config_order":d+"_"+s}))}}if(d==u.getWinType()&&s==u.getCurTabType()){var c=e.code,p=e.data;if(0==c&&p){var h=p.tip,v=p.match_node_id,_=p.tree,T=$.fn.zTree.init(n,{async:{enable:!0,url:URLS.URL_DATA_MONITOR_SUBTREE,dataType:"json",type:"get",autoParam:["area_id=id","area_level=level"],otherParam:{year:l,wintype:d,tabtype:s},dataFilter:function(e,a,t){var n=t.code,r=t.data;return 0==n&&r?r:null}},view:{nameIsHTML:!0,showTitle:!1,showIcon:!1},callback:{onClick:function(e,a,n,r){t(n)},onExpand:function(){o.reinitialise()},onCollapse:function(){o.reinitialise()},onAsyncError:function(e,a,t){b.showCommonErrorDialog(function(){})}}},_),g=T.getNodeByParam("id",v);t(g),g&&(T.expandNode(g,!0,!1,!1,!0),T.selectNode(g)),i.html(h),r.show(),o.reinitialise()}else hideLoadingMask()}},error:function(){hideLoadingMask()}})}function a(e){function a(){$.ajax({url:URLS.URL_TPL_DATA_MONITOR,async:!1,success:function(a){w!=A&&($("body").append(a),w=A),e&&e()},error:function(){w<A&&(w=y,a())}})}w==y?(w=m,a()):e&&e()}function t(e){var a=this;a.renderConfigCheckArea(e,function(){a.bindCheckArea(e)})}function n(e,a){a=a||{};var t,n=this,r=(e.TabName,n.$popupContent),i=a.wintype,o=a.tabtype,l=a.callback;t=r.find(".check-area-wrap"),showLoadingMask(),_({url:e.params_url,data:{level:e.area_level,id:e.area_id,year:e.year,wintype:i,tabtype:o},success:function(a){var r=a.code,i=a.data;0==r&&i?(t.html(template("tplConfigCheckArea",i)),n.renderChartTable(e),l&&l()):hideLoadingMask()},error:function(){hideLoadingMask()}})}function r(e){function a(e){var a=1e3,t=$("#exportContent");_({url:e,success:function(e){function n(e){t.html(template("tplExportContent",e))}var r=e.code,i=e.data;if(0==r&&i){var o=null;!function(e){function t(){_({url:URLS.URL_DATA_CHECK_EXPORT_RESULT,data:{export_task_id:e},success:function(e){var r=e.code,i=e.data,l=e.msg,c=i.stat;0==r&&i&&(1==c?(n(i),o=setTimeout(t,a)):(2==c?b.showAlertDialog({content:"生成完成",btnPosText:"下载",btnPosCB:function(e){window.open(i.url),e.hide()}}):b.showAlertDialog({title:"导出错误",content:l}),v.close()))},error:function(){}})}v.open(),n({progress:0}),t()}(i.export_task_id)}},error:function(){}})}e=f({tableDetail:!1},e);var t,n,r=this,i=r.$popupContent;t=i.find(".config-table"),n=i.find(".chart-table-wrap"),e.tableData.hasDetailBtn=e.tableDetail,t.html(template("tplConfigTable",e.tableData)),n.data("action-bound")||(n.on(d,"td[data-action-type=area_data]",function(a){var t=$(this),n=t.data("action-area-level"),i=t.data("action-area-id");r.secondPopup&&r.secondPopup.openAreaData(f({},e,{area_level:n,area_id:i}))}).on(d,"td[data-action-type=country_file]",function(e){var a=$(this).data("action-area-id");$.poorFile.showCountryFile(a)}).on(d,"td[data-action-type=family_file]",function(e){var a=$(this).data("action-family-id");$.poorFile.showFamilyFile(a)}).on(d,"td[data-action-type=file_detail]",function(e){var a=$(this).data("action-file-id");$.poorFile.showFileDetail(a)}).on(d,".detail-btn",function(a){r.secondPopup&&r.secondPopup.openDetail(e)}).on(d,".export-btn",function(e){a($(this).data("export-url"))}),n.data("action-bound",!0)),e.tableData.pagination&&function(){var a=n.find(".table-pagination"),t=e.tableData.pagination.page_total,i=e.tableData.pagination.page_cur,o=e.tableData.pagination.page_cur+1,l=e.tableData.pagination.page_cur-1;a.on(d,".arrow-first",function(a){if(1==i)return 0;e.table_page=1,r.renderChartTable(e)}).on(d,".arrow-end",function(a){if(i==t)return 0;e.table_page=t,r.renderChartTable(e)}).on(d,".arrow-left",function(a){if(l<1)return 0;e.table_page=l,r.renderChartTable(e)}).on(d,".arrow-right",function(a){if(o>t)return 0;e.table_page=o,r.renderChartTable(e)})}();var o=i,l=o.find(".page-content-wrap"),c=o.find(".monitor-tb-wrap"),p=l.data("jsp"),s=c.data("jsp");s?s.reinitialise():s=c.jScrollPane(commonJSPConfig).data("jsp"),p?p.reinitialise():p=l.jScrollPane(commonJSPConfig).data("jsp"),s.reinitialise()}function i(e){var a={};return e.find(".radio-row").each(function(e,t){var n=$(this),r=n.data("key"),i=n.find(".radio.active").data("value");a[r]=i}),e.find(".check-row").each(function(e,t){var n=$(this),r=n.data("key");a[r]=o(n).join(",")}),a}function o(e){var a=[];return e.find(".check.active").each(function(e,t){var n=$(this).data("value");n&&a.push(n)}),a}function l(e,a,t){var n,r=this,i={};if(a)for(var l=0,c=a.length;l<c;l++){var p=a[l];"object"==typeof p&&p.handler&&(i[p.rowKey]=p.handler)}(n=r.$popupContent.find(".check-area-wrap")).find(".radio-row").each(function(){var a=$(this),n=a.attr("data-key");a.data("event-bound")||(a.on(d,".radio",function(a){var o=this,l=$(this);if(l.hasClass("disabled"))return 0;l.siblings().removeClass("active"),l.addClass("active");var c=i[n];c?c.apply(o,arguments):r.renderChartTable(e,t)}),a.data("event-bound",!0))}),n.find(".check-row").each(function(){var a=$(this),t=a.find("a[data-check-all]"),n=t.length>0,i=a.find("a:not(.disabled)").not("[data-check-all]");a.data("event-bound")||(a.on(d,".check",function(l){var c=$(this);if(c[0].hasAttribute("data-check-all"))c.hasClass(s)?(c.removeClass(s),i.removeClass(s)):(c.addClass(s),i.addClass(s)),r.renderChartTable(e);else{if(c.hasClass("disabled"))return 0;c.toggleClass(s),n&&(o(a).length===i.length?t.addClass(s):t.removeClass(s)),r.renderChartTable(e)}}),a.data("event-bound",!0))})}function c(e){for(var a=this,t=e.target.split("_"),n=[],r="",i=0,o=t.length;i<o;i++)n.push(t[i].substring(0,1).toUpperCase()+t[i].substring(1));e.TabName=n.join(""),e.tabName=t[0]+n.join("").substring(t[0].length),r="render"+n.join(""),console.log(r),a[r](e)}var p,d="click",s="active",u={DETAIL_LIST:"second_popup_detail_list",AREA_DATA:"second_popup_area_data"},f=$.extend,h=$("body"),v={open:function(){p||(p=$("#exportWrap")),p.show()},close:function(){p.hide()}},b=window.Helpers,_=b.ajax,T=b.getSearchObject(),g=T.area_level,C=T.area_id,y=0,m=1,A=2,w=y;$.monitorHelper={DATA_MONITOR_SECOND_POPUP:u,renderDataMonitorTree:e,createDataMonitor:function(o){var p=(o=f({hasBack:!0},o)).mix,s=o.mixSecond,v=f({curWinType:null,curTabType:null,$popupWrap:null,$popupContent:null,$popupTitle:null,$popupTable:null,init:function(e){var a=this,t=a.$popupWrap;a.curWinType=e.wintype,a.curTabType=e.tabtype,t||(a.$popupWrap=t=$($("#tplMonitorSecondPopupWin").html()),h.append(t),t.on(d,".js-second-popup-close",function(){a.close()}));var n=$(template("tplSecondPopup",{}));t.empty().append(n),a.$popupContent=n,a.$popupTitle=n.find(".second-popup-title"),a.$popupTable=n.find(".second-popup-table")},clean:function(){var e=this;e.$popupWrap.remove(),e.$popupWrap=null},openDetail:function(e){var a=this;a.init(e);var t=a.$popupWrap;a.areaSelect.render(e,function(){t.show(),a.bindSelectArea(),a.renderContent(f({},e,{target:u.DETAIL_LIST}))})},openAreaData:function(e){var a=this;a.init(e),a.$popupWrap.show(),a.renderContent(f({},e,{target:u.AREA_DATA}))},close:function(){this.clean()},renderContent:function(e){var a=this;c.call(a,e)},bindSelectArea:function(){h.on("click",function(){var e=$(".select-box");e.removeClass("selected").find(".select-list").hide(),e.find(".arrow").removeClass("arrow-on")});var e=this.$popupContent;e.off(d,".js-select-box",this.areaSelect.toggle).off(d,".js-select-list li",this.areaSelect.choose),e.on(d,".js-select-box",this.areaSelect.toggle).on(d,".js-select-list li",this.areaSelect.choose)},renderChartTable:function(e,a){var t=this,n=v.$popupContent,r=v.$popupTitle,o=n.find(".check-area-wrap"),l={},c=t.curWinType,p=t.curTabType,d={level:e.area_level,id:e.area_id,year:e.year,wintype:c,tabtype:p,page:e.table_page||1};e.tableDetail=!1,l=i(o),showLoadingMask(),_({url:e.url,data:f(d,l),success:function(i){var o=i.code,l=i.data;0==o&&l&&("area_data"==e.secondPopupType&&(l.hasSelectArea=!1,n.find(".basic-info-wrap").html(template("tplSecondPopupBasicInfo",l)),r.text(l.win_title)),t.renderConfigTable(f({},e,{secondPopup:!0,tableData:l.table,tableDetail:e.tableDetail,tableTplId:"secondPopupTable"})),$.isFunction(a)&&a()),hideLoadingMask()},error:function(){hideLoadingMask()}})},buildConfigCheckArea:function(e){var a=this;t.call(a,e)},renderConfigTable:function(e){var a=this;r.call(a,e)},renderConfigCheckArea:function(e,a){var t=this,r=t.curWinType,i=t.curTabType;n.call(t,e,{wintype:r,tabtype:i,callback:function(){a&&a()}})},renderSecondPopupDetailList:function(e){var a=this;e=f({},e,{url:URLS.URL_DATA_MONITOR_DETAIL_TABLE,params_url:URLS.URL_DATA_MONITOR_DETAIL_PARAMS_INFO,secondPopupType:"detail_list"}),a.buildConfigCheckArea(e)},renderSecondPopupAreaData:function(e){var a=this;e=f({},e,{url:URLS.URL_DATA_MONITOR_AREA_DATA_TABLE,secondPopupType:"area_data"}),a.renderChartTable(e)},bindCheckArea:function(e,a,t){var n=this;l.call(n,e,a,t)},areaSelect:{toggle:function(){var e=$(this),a=e.find(".select-list"),t=e.parents(".select-area").find(".js-select-box").not(this);return e.hasClass("forbid")?0:(e.toggleClass("selected"),a.toggle(),e.find(".arrow").toggleClass("arrow-on"),t.removeClass("selected").find(".select-list").hide(),t.find(".arrow").removeClass("arrow-on"),function(){var e=a.innerWidth(),t=a.innerHeight();e=e>150?150:e,a.find(".jspPane").length<1&&a.width(e),t>320&&a.jScrollPane(commonJSPConfig)}(),!1)},choose:function(){function e(){var e={url:URLS.URL_DATA_MONITOR_DETAIL_TABLE,params_url:URLS.URL_DATA_MONITOR_DETAIL_PARAMS_INFO,secondPopup:!0,secondPopupType:"detail_list",area_level:i,area_id:r,year:o,wintype:v.curWinType,tabtype:v.curTabType};v.buildConfigCheckArea(e)}var a=$(this),t=v.$popupContent,n=t.find(".basic-info-wrap .select-area");if(a.parents("#areaBarrio").length>0){var r=a.attr("data-id"),i=a.closest(".js-select-box").attr("level"),o=n.find("#selectYear .select-box>span").attr("data-value");e()}if(a.parents("#selectYear").length>0){var o=a.attr("data-year"),i=n.find("#areaBarrio .js-select-box").last().attr("level");""==(r=n.find("#areaBarrio .js-select-box").last().attr("selected_id"))&&(r=n.find("#areaBarrio .js-select-box").eq(-2).attr("selected_id"),i=n.find("#areaBarrio .js-select-box").eq(-2).attr("level")),e()}showLoadingMask(),_({url:URLS.URL_DATA_MONITOR_DETAIL_BASIC_INFO,data:{level:i,id:r,year:o,wintype:b.getWinType(),tabtype:b.getCurTabType()},success:function(e){var a=e.code,n=e.data;0==a&&n?(n.hasSelectArea=!0,t.find(".basic-info-wrap").html(template("tplSecondPopupBasicInfo",n))):hideLoadingMask()},error:function(){hideLoadingMask()}})},render:function(e,a){var t=v.$popupTitle,n=v.$popupContent,r={},i={level:e.area_level,id:e.area_id,year:e.year,wintype:v.curWinType,tabtype:v.curTabType,page:e.table_page||1};showLoadingMask(),_({url:URLS.URL_DATA_MONITOR_DETAIL_BASIC_INFO,data:f(i,r),success:function(e){var r=e.code,i=e.data;i.AREA_SCOPE=AREA_SCOPE,0==r&&i?(i.hasSelectArea=!0,t.text(i.win_title),n.find(".basic-info-wrap").html(template("tplSecondPopupBasicInfo",i)),$.isFunction(a)&&a()):hideLoadingMask()},error:function(){hideLoadingMask()}})}}},s),b=f({$popupWrap:null,$popupHeader:null,$popupTree:null,$popupContent:null,curAreaName:"",treeCurLevel:g||DEFAULT_LEVEL,treeCurAreaID:C||DEFAULT_AREA_ID,init:function(e){var t=this;a(function(){if(!t.$popupWrap){var a=$($("#tplMonitorPopupWin").html());h.append(a);var n=a.find(".monitor-header"),r=a.find(".monitor-tree"),i=a.find(".monitor-content");t.$popupWrap=a,t.$popupHeader=n,t.$popupTree=r,t.$popupContent=i}e&&e()})},clean:function(){var e=this;e.$popupWrap.remove(),e.$popupWrap=null},bindHeader:function(){var e=this,a=e.$popupWrap,t=e.$popupHeader;a.off(d).on(d,".js-monitor-close",e.popup.close);var n=t.find(".monitor-nav");n.on(d,"li",function(a){var t=$(this),n={};n.configOrder=t.data("config-order"),t.siblings().removeClass("active"),t.addClass("active"),e.renderTree(n)}),t.find(".tab-year").on(d,"i",function(a){var t={};if($(this).hasClass("js-forbid"))return 0;t.configOrder=n.find("li.active").data("config-order"),e.renderTree(t)})},popup:{open:function(){b.$popupWrap.show()},close:function(){b.clean()}},secondPopup:v,getWinType:function(){return this.$popupHeader.find(".header-title").data("win-type")},getCurYear:function(){return this.$popupHeader.find(".tab-year .active").data("value")},getCurTabType:function(){return this.$popupHeader.find(".monitor-nav .active").data("tab-type")},buildCheckAreaHtml:function(e,a){var t=$.components.buildCheckRow,n='<table class="check-area-table">';a=a||{default:0};for(var r=0;r<e.length;r++){var i=0;if("object"==typeof e[r]){for(var o in a)if(o==e[r].rowKey){n+=t(e[r],a[o]),i=1;break}}else for(var o in a)if(o==e[r]){n+=t(e[r],a[o]),i=1;break}0==i&&(n+=t(e[r]))}return n+"</table>"},bindCheckArea:function(e,a,t){var n=this;l.call(n,e,a,t)},buildCheckArea:function(e,a){a=f({},a);var t=this,n=t.$popupContent,r=a.rowKeyArr,i=a.activePositionObj,o=a.callback,l=n.find(".check-area-wrap"),c=t.buildCheckAreaHtml(r,e.checkActiveObj||i);l.html(c),t.renderContentBasicInfo(e),t.bindCheckArea(e,r,o)},buildConfigCheckArea:function(e){var a=this;t.call(a,e),a.renderContentBasicInfo(e)},renderWin:function(e){var a=this,t=a.$popupHeader;showLoadingMask();var n={level:e.area_level,id:e.area_id};e.year&&(n.year=e.year),_({url:URLS.URL_DATA_MONITOR_BASIC_INFO,data:n,success:function(n){var r=n.code,i=n.data;if(i=f({},i,e.target,{hasBack:e.hasBack}),0==r&&i){t.html(template("tplMonitorHeader",i));var o=t.find(".tab-switch");$.components.tabSwitch(o,i.years.available_years,i.years.selected_value),a.bindHeader(),a.renderTree(e)}else hideLoadingMask()},error:function(){hideLoadingMask()}})},renderTree:function(a){var t=this,n=t.$popupTree,a=f({year:t.getCurYear(),area_level:t.treeCurLevel,area_id:t.treeCurAreaID,wintype:t.getWinType(),tabtype:t.getCurTabType()},a);t.treeCurLevel=a.area_level,t.treeCurAreaID=a.area_id,e(n,f({instance:t},a))},showDataMonitor:function(e){var a=this;a.init(function(){a.renderWin(e),a.popup.open()})},renderContent:function(e){var a=this;c.call(a,e)},renderPageContent:function(e){e=f({tplID:"tplMonitorPageContentCommon"},e);var a=this.$popupContent,t=e.tplID;a.html(template(t))},renderContentBasicInfo:function(e){var a=this,t=(e.TabName,a.$popupContent),n=a.getCurTabType(),r=t.find(".check-area-wrap");showLoadingMask(),_({url:URLS.URL_DATA_MONITOR_CONTENT_BASIC_INFO,data:{level:e.area_level,id:e.area_id,year:e.year},success:function(e){if(n==a.getCurTabType()){var t=e.code,i=e.data;0==t&&i?r.find("[data-key='scope'] .radio").each(function(e,a){var t=$(this),n=e+1;i.scope_available[n]||t.addClass("disabled")}):hideLoadingMask()}},error:function(){hideLoadingMask()}})},renderConfigCheckArea:function(e,a){var t=this,r=t.getWinType(),i=t.getCurTabType();n.call(t,e,{wintype:r,tabtype:i,callback:function(){a&&a()}})},renderChartTable:function(e,a){function t(){return e.wintype||c.getWinType()}function n(){return e.tabtype||c.getCurTabType()}function r(a){var t=[];for(var n in a)"chart_config"==n.substring(0,12)&&t.push({name:n,data:a[n]});for(var r=0;r<t.length;r++){var i=a[t[r].name],o=t[r].name.substring(13);if(e.chartHeaderId)l=e.chartHeaderId+$.components.underlineToCamel(o);else var l=e.tabName+"Chart"+$.components.underlineToCamel(o);var c=$("#"+l);echarts.init(c[0]).setOption(commonEchartConfig[i.convert_method](i.config)),function(e,a){var t=a.expand_config;if(t){var n=e.closest(".chart-item"),r=n.find(".chart-item-title"),i=n.find(".chart-item-extra"),o=n.closest(".chart-row"),l=$(['<div class="chart-item chart-whole chart-expand">','<div class="chart-item-title">',r.html(),"</div>",'<div class="chart-item-extra">','<div class="btn-cyan btn-collapse">收回</div>',"</div>",'<div class="chart"></div>',"</div>"].join(""));i.length||(i=$('<div class="chart-item-extra"></div>'),n.append(i)),i.prepend('<div class="btn-cyan btn-expand">展开</div>'),o.append(l);var c,p=l.find(".chart");n.find(".btn-expand").on(d,function(){o.addClass("chart-expanded"),l.show(),c||(c=echarts.init(p[0])).setOption(commonEchartConfig[a.expand_convert_method](t))}),l.find(".btn-collapse").on(d,function(){o.removeClass("chart-expanded"),l.hide()})}}(c,i)}}var o,l,c=this,p=c.$popupContent,s=(e.TabName,e.tplID||"tpl"+e.TabName+"ChartTable"),u=t(),h=n();e=f({},e),o=p.find(".check-area-wrap"),l=p.find(".chart-table-wrap");var v={},b={level:e.area_level,id:e.area_id,year:e.year,wintype:u,tabtype:h,page:e.table_page||1};v=i(o),showLoadingMask(),_({url:e.url,data:f(b,v),success:function(i){if(u==t()&&h==n()){var o=i.code,p=i.data;if(0==o&&p){l.html(template(s,p)),c.renderConfigTable(f({},e,{tableData:p.table,tableDetail:e.tableDetail,tableTplId:e.tableTplId})),r(p);var d=c.$popupContent.find(".page-content-wrap"),v=d.data("jsp");v?v.reinitialise():v=d.jScrollPane(commonJSPConfig).data("jsp"),$.isFunction(a)&&a()}hideLoadingMask()}},error:function(){hideLoadingMask()}})},renderConfigTable:function(e){var a=this;r.call(a,e)},renderConfigOrder:function(e){var a=this;e.url=URLS.URL_DATA_MONITOR_ORDER_TABLE,e.params_url=URLS.URL_DATA_MONITOR_ORDER_BASIC_INFO,a.$popupContent.html(template("tplConfigOrder")),a.buildConfigCheckArea(e)}},p);return b}}});