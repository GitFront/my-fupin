!function(t){function e(e){return t(e).data("treegrid")?"treegrid":"datagrid"}function i(e,i,r){var n=t(e),a=n.datagrid("getPanel").find("div.datagrid-header");(i?a.find('.datagrid-filter[name="'+i+'"]'):a.find(".datagrid-filter")).each(function(){var e=t(this).attr("name"),i=n.datagrid("getColumnOption",e),a=t(this).closest("div.datagrid-filter-c"),o=a.find("a.datagrid-filter-btn");void 0!=r?this.filter.resize(this,r):(this.filter.resize(this,10),this.filter.resize(this,a.width()-o._outerWidth())),a.width()>i.boxWidth+i.deltaWidth-1&&(i.boxWidth=a.width()-i.deltaWidth+1,i.width=i.boxWidth+i.deltaWidth)}),t(e).datagrid("fixColumnSize")}function r(e,i){return t(e).datagrid("getPanel").find("div.datagrid-header").find('tr.datagrid-filter-row td[field="'+i+'"] .datagrid-filter')}function n(i,r){for(var n=e(i),a=t(i)[n]("options").filterRules,o=0;o<a.length;o++)if(a[o].field==r)return o;return-1}function a(i,r){var a=e(i),o=t(i)[a]("options").filterRules,l=n(i,r);return l>=0?o[l]:null}function o(i,a){var o=e(i),d=t(i)[o]("options"),f=d.filterRules;if("nofilter"==a.op)l(i,a.field);else{var u=n(i,a.field);u>=0?t.extend(f[u],a):f.push(a)}var s=r(i,a.field);if(s.length){"nofilter"!=a.op&&s[0].filter.setValue(s,a.value);var c=s[0].menu;if(c){c.find("."+d.filterMenuIconCls).removeClass(d.filterMenuIconCls);var h=c.menu("findItem",d.operators[a.op].text);c.menu("setIcon",{target:h.target,iconCls:d.filterMenuIconCls})}}}function l(i,a){function o(t){for(var e=0;e<t.length;e++){var n=r(i,t[e]);if(n.length){n[0].filter.setValue(n,"");var a=n[0].menu;a&&a.find("."+f.filterMenuIconCls).removeClass(f.filterMenuIconCls)}}}var l=e(i),d=t(i),f=d[l]("options");if(a){var u=n(i,a);u>=0&&f.filterRules.splice(u,1),o([a])}else f.filterRules=[],o(d.datagrid("getColumnFields",!0).concat(d.datagrid("getColumnFields")))}function d(i){var r=e(i),n=t.data(i,r);n.options.remoteFilter?t(i)[r]("load"):(t(i)[r]("getPager").pagination("refresh",{pageNumber:1}),t(i)[r]("options").pageNumber=1,t(i)[r]("loadData",n.filterSource||n.data))}function f(i,r){function n(e,i){if(!e||!e.length)return[];var r=[];return t.map(e,function(t){t._parentId=i,r.push(t),r=r.concat(n(t.children,t[l.idField]))}),r}var a=e(this),o=t.data(this,a),l=o.options;if("datagrid"==a&&t.isArray(i))i={total:i.length,rows:i};else if("treegrid"==a&&t.isArray(i)){var d=n(i,r);t.map(d,function(t){t.children=void 0}),i={total:d.length,rows:d}}if(!l.remoteFilter){if(o.filterSource){if("datagrid"!=a||l.isSorting){if("treegrid"==a&&!l.isSorting){var f=t.extend(!0,[],i.rows);o.filterSource.total+=f.length,o.filterSource.rows=o.filterSource.rows.concat(f)}}else o.filterSource=i;l.isSorting=void 0}else o.filterSource=i;if(i=l.filterMatcher.call(this,{total:o.filterSource.total,rows:t.extend(!0,[],o.filterSource.rows)}),l.pagination){var u=t(this),s=u[a]("getPager");if(s.pagination({onSelectPage:function(t,e){l.pageNumber=t,l.pageSize=e,s.pagination("refresh",{pageNumber:t,pageSize:e}),u[a]("loadData",o.filterSource)},onBeforeRefresh:function(){return u[a]("reload"),!1}}),"datagrid"==a){p=(g=(l.pageNumber-1)*parseInt(l.pageSize))+parseInt(l.pageSize);i.rows=i.rows.slice(g,p)}else{var c=[],h=[];t.map(i.rows,function(t){t._parentId?h.push(t):c.push(t)}),i.total=c.length;var g=(l.pageNumber-1)*parseInt(l.pageSize),p=g+parseInt(l.pageSize);i.rows=t.extend(!0,[],c.slice(g,p).concat(h))}}}return i}function u(r,n){function a(e){var n=c.dc,a=t(r).datagrid("getColumnFields",e);e&&h.rownumbers&&a.unshift("_");var o=(e?n.header1:n.header2).find("table.datagrid-htable");o.find(".datagrid-filter").each(function(){this.filter.destroy&&this.filter.destroy(this),this.menu&&t(this.menu).menu("destroy")}),o.find("tr.datagrid-filter-row").remove();var d=t('<tr class="datagrid-header-row datagrid-filter-row"></tr>');"bottom"==h.filterPosition?d.appendTo(o.find("tbody")):d.prependTo(o.find("tbody"));for(var f=0;f<a.length;f++){var s=a[f],g=t(r).datagrid("getColumnOption",s),p=t("<td></td>").attr("field",s).appendTo(d);if(g&&g.hidden&&p.hide(),"_"!=s&&(!g||!g.checkbox&&!g.expander)){var m=t('<div class="datagrid-filter-c"></div>').appendTo(p),v=u(s);v||(v=t.extend({},{field:s,type:h.defaultFilterType,options:h.defaultFilterOptions}));var w=h.filters[v.type],S=w.init(m,v.options||{});S.addClass("datagrid-filter").attr("name",s),S[0].filter=w,S[0].menu=l(m,v.op),v.options&&v.options.onInit&&v.options.onInit.call(S[0],r),i(r,s)}}}function l(e,i){if(!i)return null;var n=t('<a class="datagrid-filter-btn">&nbsp;</a>').addClass(h.filterBtnIconCls);"right"==h.filterBtnPosition?n.appendTo(e):n.prependTo(e);var a=t("<div></div>").appendTo("body");return t.map(["nofilter"].concat(i),function(e){var i=h.operators[e];i&&t("<div></div>").attr("name",e).html(i.text).appendTo(a)}),a.menu({alignTo:n,onClick:function(e){var i=t(this).menu("options").alignTo,n=i.closest("td[field]"),a=n.attr("field"),l=n.find(".datagrid-filter"),f=l[0].filter.getValue(l);0!=h.onClickMenu.call(r,e,i,a)&&(o(r,{field:a,op:e.name,value:f}),d(r))}}),n[0].menu=a,n.bind("click",{menu:a},function(e){return t(this.menu).menu("show"),!1}),a}function u(t){for(var e=0;e<n.length;e++){var i=n[e];if(i.field==t)return i}return null}n=n||[];var s=e(r),c=t.data(r,s),h=c.options;h.filterRules.length||(h.filterRules=[]);var g=h.onResizeColumn;h.onResizeColumn=function(e,n){h.fitColumns?(i(r,null,10),t(r).datagrid("fitColumns"),i(r)):i(r,e),g.call(r,e,n)};var p=h.onResize;h.onResize=function(e,n){i(r,null,10),t(r).datagrid("fitColumns"),i(r),p.call(this,e,n)};var m=h.onBeforeLoad;h.onBeforeLoad=function(t,e){t&&(t.filterRules=h.filterStringify(h.filterRules)),e&&(e.filterRules=h.filterStringify(h.filterRules));var i=m.call(this,t,e);return 0!=i&&h.url&&(c.filterSource=null),i};var v=t.data(r,"datagrid").options,w=v.onBeforeSortColumn;v.onBeforeSortColumn=function(t,e){var i=w.call(this,t,e);return 0!=i&&(h.isSorting=!0),i};var S=h.onBeforeEdit;h.onBeforeEdit=function(e,i){var r=S.call(this,e,i);return c.originalEditingRow=t.extend(!0,{},"treegrid"==s?e:i),r};var b=h.onAfterEdit;h.onAfterEdit=function(e,i,r){if(h.idField&&c.filterSource)for(var n=0;n<c.filterSource.rows.length;n++){var a=c.filterSource.rows[n];if(a[h.idField]==c.originalEditingRow[h.idField]){t.extend(a,"treegrid"==s?e:i);break}}b.call(this,e,i,r)},h.loadFilter=function(t,e){var i=h.oldLoadFilter.call(this,t,e);return f.call(this,i,e)},t("#datagrid-filter-style").length||t("head").append('<style id="datagrid-filter-style">a.datagrid-filter-btn{display:inline-block;width:22px;height:22px;margin:0;vertical-align:top;cursor:pointer;opacity:0.6;filter:alpha(opacity=60);}a:hover.datagrid-filter-btn{opacity:1;filter:alpha(opacity=100);}.datagrid-filter-row .textbox,.datagrid-filter-row .textbox .textbox-text{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}.datagrid-filter-row input{margin:0;-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}</style>'),a(!0),a(),h.fitColumns&&setTimeout(function(){i(r)},0),t.map(h.filterRules,function(t){o(r,t)})}var s=t.fn.datagrid.methods.autoSizeColumn;t.fn.datagrid.methods.autoSizeColumn=function(e,r){return e.each(function(){i(this,r,10),s.call(t.fn.datagrid.methods,t(this),r),i(this,r)})};var c=t.fn.datagrid.methods.loadData;t.fn.datagrid.methods.loadData=function(e,i){return e.each(function(){t.data(this,"datagrid").filterSource=null}),c.call(t.fn.datagrid.methods,e,i)};var h=t.fn.treegrid.methods.loadData;t.fn.treegrid.methods.loadData=function(e,i){return e.each(function(){t.data(this,"treegrid").filterSource=null}),h.call(t.fn.treegrid.methods,e,i)};var g=t.fn.datagrid.methods.appendRow;t.fn.datagrid.methods.appendRow=function(e,i){var r=g.call(t.fn.datagrid.methods,e,i);return e.each(function(){var e=t(this).data("datagrid");e.filterSource&&(e.filterSource.total++,e.filterSource.rows.push(i))}),r};var p=t.fn.treegrid.methods.append;t.fn.treegrid.methods.append=function(e,i){var r=p.call(t.fn.treegrid.methods,e,i);return e.each(function(){}),r};var m=t.fn.datagrid.methods.deleteRow;t.fn.datagrid.methods.deleteRow=function(e,i){return e.each(function(){var e=t(this).data("datagrid"),r=e.options;if(e.filterSource&&r.idField)for(var n=0;n<e.filterSource.rows.length;n++)if(e.filterSource.rows[n][r.idField]==e.data.rows[i][r.idField]){e.filterSource.rows.splice(n,1),e.filterSource.total--;break}}),m.call(t.fn.datagrid.methods,e,i)};var v={filterMenuIconCls:"icon-ok",filterBtnIconCls:"icon-filter",filterBtnPosition:"right",filterPosition:"bottom",remoteFilter:!1,filterDelay:400,filterRules:[],filterMatcher:function(i){function r(t,e){for(var i=l.filterRules,r=0;r<i.length;r++){var n=i[r],a=t[n.field],d=o.datagrid("getColumnOption",n.field);if(d&&d.formatter&&(a=d.formatter(t[n.field],t,e)),void 0==a&&(a=""),!l.operators[n.op].isMatch(a,n.value))return!1}return!0}function n(t,e){for(var i=0;i<t.length;i++){var r=t[i];if(r[l.idField]==e)return r}return null}var a=e(this),o=t(this),l=t.data(this,a).options;if(l.filterRules.length){var d=[];if("treegrid"==a){var f={};t.map(i.rows,function(t){if(r(t,t[l.idField]))for(f[t[l.idField]]=t,t=n(i.rows,t._parentId);t;)f[t[l.idField]]=t,t=n(i.rows,t._parentId)});for(var u in f)d.push(f[u])}else for(var s=0;s<i.rows.length;s++){var c=i.rows[s];r(c,s)&&d.push(c)}i={total:i.total-(i.rows.length-d.length),rows:d}}return i},defaultFilterType:"text",defaultFilterOperator:"contains",defaultFilterOptions:{onInit:function(i){function r(){var e=o.attr("name"),r=t(i)[n]("getFilterRule",e),l=o.val();""!=l?(r&&r.value!=l||!r)&&(t(i)[n]("addFilterRule",{field:e,op:a.defaultFilterOperator,value:l}),t(i)[n]("doFilter")):r&&(t(i)[n]("removeFilterRule",e),t(i)[n]("doFilter"))}var n=e(i),a=t(i)[n]("options"),o=t(this);o.unbind(".filter").bind("keydown.filter",function(e){t(this);this.timer&&clearTimeout(this.timer),13==e.keyCode?r():this.timer=setTimeout(function(){r()},a.filterDelay)})}},filterStringify:function(t){return JSON.stringify(t)},onClickMenu:function(t,e){}};t.extend(t.fn.datagrid.defaults,v),t.extend(t.fn.treegrid.defaults,v),t.fn.datagrid.defaults.filters=t.extend({},t.fn.datagrid.defaults.editors,{label:{init:function(e,i){return t("<span></span>").appendTo(e)},getValue:function(e){return t(e).html()},setValue:function(e,i){t(e).html(i)},resize:function(e,i){t(e)._outerWidth(i)._outerHeight(22)}}}),t.fn.treegrid.defaults.filters=t.fn.datagrid.defaults.filters,t.fn.datagrid.defaults.operators={nofilter:{text:"No Filter"},contains:{text:"Contains",isMatch:function(t,e){return t=String(t),e=String(e),t.toLowerCase().indexOf(e.toLowerCase())>=0}},equal:{text:"Equal",isMatch:function(t,e){return t==e}},notequal:{text:"Not Equal",isMatch:function(t,e){return t!=e}},beginwith:{text:"Begin With",isMatch:function(t,e){return t=String(t),e=String(e),0==t.toLowerCase().indexOf(e.toLowerCase())}},endwith:{text:"End With",isMatch:function(t,e){return t=String(t),e=String(e),-1!==t.toLowerCase().indexOf(e.toLowerCase(),t.length-e.length)}},less:{text:"Less",isMatch:function(t,e){return t<e}},lessorequal:{text:"Less Or Equal",isMatch:function(t,e){return t<=e}},greater:{text:"Greater",isMatch:function(t,e){return t>e}},greaterorequal:{text:"Greater Or Equal",isMatch:function(t,e){return t>=e}}},t.fn.treegrid.defaults.operators=t.fn.datagrid.defaults.operators,t.extend(t.fn.datagrid.methods,{enableFilter:function(i,r){return i.each(function(){var i=e(this),n=t.data(this,i).options;n.oldLoadFilter=n.loadFilter,u(this,r),t(this)[i]("resize"),n.filterRules.length&&(n.remoteFilter?d(this):n.data&&d(this))})},disableFilter:function(i){return i.each(function(){var i=e(this),r=t.data(this,i).options,n=t(this).data("datagrid").dc,a=n.header1.add(n.header2).find(".datagrid-filter-row");a.find(".datagrid-filter-btn").each(function(){t(this.menu).menu("destroy")}),a.find(".combo-f").each(function(){t(this).combo("destroy")}),t(this)[i]({loadFilter:r.oldLoadFilter||void 0,oldLoadFilter:null})})},getFilterRule:function(t,e){return a(t[0],e)},addFilterRule:function(t,e){return t.each(function(){o(this,e)})},removeFilterRule:function(t,e){return t.each(function(){l(this,e)})},doFilter:function(t){return t.each(function(){d(this)})},getFilterComponent:function(t,e){return r(t[0],e)},resizeFilter:function(t,e){return t.each(function(){i(this,e)})}})}(jQuery);