$(function(){var e=Helpers.ajax;$.poorService={$poorServiceWrap:$("#poorServiceWrap"),$poorServiceIndexWrap:$("#poorServiceIndexWrap"),$popupPoorServiceDetail:$("#popupPoorServiceDetail"),init:function(){var e={};this.renderPoorServiceIndex(e),$("body").on("click",function(){var e=$(".select-box");e.removeClass("selected").find(".select-list").hide(),e.find(".arrow").removeClass("arrow-on")})},renderPoorServiceIndex:function(t){var r=this,a=t.curLevel||DEFAULT_LEVEL,o=t.curAreaID||DEFAULT_AREA_ID;e({url:URLS.URL_DATA_POOR_SERVICE_INDEX,data:{level:a,id:o},success:function(e){var a=e.code,o=e.data;if(0==a&&o){console.log(o),r.$poorServiceIndexWrap.html(template("tplPoorServiceIndex",o));var n=o.personal.chart_config_done,i=o.personal.chart_config_doing,c=o.legal_person.chart_config_doing,l=o.legal_person.chart_config_done;echarts.init(document.getElementById("personalDoneChart")).setOption(commonEchartConfig[n.convert_method](n.config)),echarts.init(document.getElementById("personalDoingChart")).setOption(commonEchartConfig[i.convert_method](i.config)),echarts.init(document.getElementById("legalPersonDoingChart")).setOption(commonEchartConfig[c.convert_method](c.config)),echarts.init(document.getElementById("legalPersonDoneChart")).setOption(commonEchartConfig[l.convert_method](l.config)),r.bindIndexChartTab(),r.bindSelectArea(),r.bindIndexDetail(),r.renderPoorServiceLingnan(t)}},error:function(){}})},renderPoorServiceLingnan:function(t){var r=this,a=t.curLevel||DEFAULT_LEVEL,o=t.curAreaID||DEFAULT_AREA_ID,n=$("#lingnanSelect").attr("selected_value"),i=t.time||n;e({url:URLS.URL_DATA_POOR_SERVICE_INDEX_DATA_LINGNAN,data:{level:a,id:o,time:i},success:function(e){var t=e.code,a=e.data;0==t&&a&&($("#indexLingnan").html(template("tplIndexLingnan",a)),echarts.init(document.getElementById("indexLingnanChart")).setOption(commonEchartConfig[a.chart_config.convert_method](a.chart_config.config)),r.bindSelectArea())},error:function(){}})},bindIndexChartTab:function(){$(".chart-wrap-50p .blue-tab li").on("click",function(e){var t=$(this),r=t.attr("data-target"),a=t.parents(".chart-wrap-50p").find("#"+r);t.siblings().removeClass("active"),t.addClass("active"),a.siblings().addClass("hide"),a.removeClass("hide")})},bindSelectArea:function(){var e=this;e.$poorServiceWrap.off("click",".js-select-box",e.areaSelect.toggle).off("click",".js-select-list li",e.areaSelect.choose),e.$poorServiceWrap.on("click",".js-select-box",e.areaSelect.toggle).on("click",".js-select-list li",e.areaSelect.choose)},areaSelect:{toggle:function(){var e=$(this),t=e.find(".select-list"),r=$(".select-box").not(this);return e.toggleClass("selected"),t.toggle(),e.find(".arrow").toggleClass("arrow-on"),r.removeClass("selected").find(".select-list").hide(),r.find(".arrow").removeClass("arrow-on"),function(){var e=t.innerWidth(),r=t.innerHeight();e=e>150?150:e,t.find(".jspPane").length<1&&t.width(e),r>320&&t.jScrollPane(commonJSPConfig)}(),!1},choose:function(){var e=$(this),t=$.poorService;if(e.parents("#areaBarrio").length>0){r={curAreaID:e.attr("data-id"),curLevel:e.closest(".js-select-box").attr("level")};t.renderPoorServiceIndex(r)}if(e.parents("#lingnanSelect").length>0){var r={},a=t.$poorServiceIndexWrap.find("#areaBarrio .js-select-box"),o=t.getSelectLevelId(a);r.time=e.attr("data-value"),r=$.extend(r,o),t.renderPoorServiceLingnan(r)}if(e.parents("#areaBarrioPopup").length>0){var n=t.$popupPoorServiceDetail.find("#popupTitle"),r={curAreaID:e.attr("data-id"),curLevel:e.closest(".js-select-box").attr("level"),subject:n.attr("data-subject"),status:n.attr("data-status")};t.renderPopupDetail(r)}if(e.parents("#typeSelect").length>0){var n=t.$popupPoorServiceDetail.find("#popupTitle"),a=t.$popupPoorServiceDetail.find("#areaBarrioPopup .js-select-box"),o=t.getSelectLevelId(a),r={type:e.attr("data-value"),subject:n.attr("data-subject"),status:n.attr("data-status")};r=$.extend(r,o),t.renderPopupSearchTable(r)}}},getSelectLevelId:function(e){var t={};return t.curLevel=e.last().attr("level"),t.curAreaID=e.last().attr("selected_id"),""==t.curAreaID&&(t.curAreaID=e.eq(-2).attr("selected_id"),t.curLevel=e.eq(-2).attr("level")),t},bindIndexDetail:function(){return 0},bindPopupClose:function(){var e=this;e.$popupPoorServiceDetail.find(".js-popup-close").on("click",function(t){e.$popupPoorServiceDetail.hide()})},bindSearchBtn:function(){var e=this;e.$popupPoorServiceDetail.find("#popupSearchBtn").on("click",function(t){var r=e.$popupPoorServiceDetail.find("#popupTitle"),a=e.$popupPoorServiceDetail.find("#typeSelect"),o=e.$popupPoorServiceDetail.find("#areaBarrioPopup .js-select-box"),n=e.getSelectLevelId(o),i={type:a.attr("selected_value"),subject:r.attr("data-subject"),status:r.attr("data-status")};i=$.extend(i,n),e.renderPopupSearchTable(i)})},exportWrap:{open:function(){$("#exportWrap").show()},close:function(){$("#exportWrap").hide()}},renderPopupDetail:function(t){var r,a,o=this;e({url:URLS.URL_DATA_POOR_SERVICE_ITEM_LIST_BASIC_INFO,data:{level:t.curLevel,id:t.curAreaID,subject:t.subject,status:t.status},success:function(e){var n=e.code,i=e.data;if(0==n&&i){switch(t.subject){case"personal":r="个人";break;case"legal_person":r="法人"}switch(t.status){case"doing":a="在办";break;case"done":a="已办"}i.popupTitle=r+"事项"+a+"列表",o.$popupPoorServiceDetail.html(template("tplPopupPoorServiceDetail",i)),o.bindPopupClose(),o.bindSelectArea(),o.bindSearchBtn();var c=o.$popupPoorServiceDetail.find("#popupTitle");c.attr("data-subject",t.subject),c.attr("data-status",t.status);var l=o.$popupPoorServiceDetail.find("#typeSelect");t.type=l.attr("selected_value"),o.renderPopupSearchTable(t)}},error:function(){}})},renderPopupSearchTable:function(t){function r(t){var r=1e3,a=$("#exportContent");e({url:t,success:function(t){function n(e){a.html(template("tplExportContent",e))}var i=t.code,c=t.data;if(0==i&&c){var l=null;!function(t){function a(){e({url:URLS.URL_DATA_CHECK_EXPORT_RESULT,data:{export_task_id:t},success:function(e){var t=e.code,i=e.data,c=e.msg,p=i.stat;0==t&&i&&(1==p?(n(i),l=setTimeout(a,r)):(2==p?Helpers.showAlertDialog({content:"生成完成",btnPosText:"下载",btnPosCB:function(e){window.open(i.url),e.hide()}}):Helpers.showAlertDialog({title:"导出错误",content:c}),o.exportWrap.close()))},error:function(){}})}o.exportWrap.open(),n({progress:0}),a()}(c.export_task_id)}},error:function(){}})}function a(e,t){var r=o.$popupPoorServiceDetail.find(".table-pagination"),a=e.pagination.page_total,n=e.pagination.page_cur,i=e.pagination.page_cur+1,c=e.pagination.page_cur-1;r.on("click",".arrow-first",function(e){if(1==n)return 0;t.table_page=1,o.renderPopupSearchTable(t)}).on("click",".arrow-end",function(e){if(n==a)return 0;t.table_page=a,o.renderPopupSearchTable(t)}).on("click",".arrow-left",function(e){if(c<1)return 0;t.table_page=c,o.renderPopupSearchTable(t)}).on("click",".arrow-right",function(e){if(i>a)return 0;t.table_page=i,o.renderPopupSearchTable(t)})}var o=this;e({url:URLS.URL_DATA_POOR_SERVICE_ITEM_LIST_SEARCH,data:{level:t.curLevel,id:t.curAreaID,subject:t.subject,status:t.status,type:t.type||1,keyword:$("#keywordInput").val()||"",page:t.table_page||1},success:function(e){var n=e.code,i=e.data;if(0==n&&i){var c=o.$popupPoorServiceDetail.find("#popupSearchTable"),l=o.$popupPoorServiceDetail.find("#searchResultCount"),p=o.$popupPoorServiceDetail.find(".none-search");l.text(i.amount_total),i.amount_total<1?(p.show(),c.hide()):(c.html(template("tplPopupSearchTable",i)),i.table.pagination&&a(i.table,t),c.data("action-bound")||(c.on("click","td[data-action-type=country_file]",function(e){var t=$(this).data("action-area-id");$.poorFile.showCountryFile(t)}).on("click","td[data-action-type=family_file]",function(e){var t=$(this).data("action-family-id");$.poorFile.showFamilyFile(t)}).on("click",".export-btn",function(e){r($(this).data("export-url"))}),c.data("action-bound",!0)))}},error:function(){}})}},$.poorService.init()});